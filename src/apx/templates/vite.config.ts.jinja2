import tailwindcss from "@tailwindcss/vite";
import react from "@vitejs/plugin-react";
import path from "path";
import { defineConfig, type Plugin } from "vite";
import { tanstackRouter } from "@tanstack/router-plugin/vite";
import { generate, type  } from "orval";
import { spawn } from "child_process";

const APP_NAME = "{{app_name}}";
const APP_UI_PATH = "./src/" + APP_NAME + "/ui";

type StepAction = () => void | Promise<void>;
type StepSpec = { name: string; action: StepAction };
const Step = (s: StepSpec) => s;

function runOnReload(steps: StepSpec[]): Plugin {
  let timer: NodeJS.Timeout | null = null;
  let stopping = false;

  async function runAll() {
    for (const s of steps) {
      if (stopping) break;
      const start = Date.now();
      try {
        await s.action();
        console.log(`[vite-plugin-run] ${s.name} ✓ (${Date.now() - start} ms)`);
      } catch (err) {
        console.error(`[vite-plugin-run] ${s.name} ✗`, err);
      }
    }
  }

  function stop() {
    if (stopping) return;
    stopping = true;
    if (timer) clearTimeout(timer);
    console.log("[vite-plugin-run] stopping...");
  }

  return {
    name: "vite-plugin-run",
    apply: () => true,
    configResolved() {
      process.on("SIGINT", stop);
      process.on("SIGTERM", stop);
    },
    configureServer(server) {
      server.httpServer?.once("close", stop);
    },
    async buildStart() {
      await runAll();
    },
    handleHotUpdate() {
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => (timer = null, void runAll()), 100);
    },
    closeBundle() {
      stop();
    },
  };
}



// https://vite.dev/config/
export default defineConfig({
  root: APP_UI_PATH,
  plugins: [
    runOnReload([
      Step({
        name: "openapi",
        action: () => {
          spawn("uv", ["run", "apx", "openapi", `${APP_NAME}.api.app:app`, "node_modules/.tmp/openapi.json"], { stdio: "inherit" });
        },
      }),
      Step({
        name: "generate",
        action: () => generate({
          input: "node_modules/.tmp/openapi.json",
          output: {
            target: `${APP_UI_PATH}/lib/api.ts`,
          },
        }),
      }),
    ]),
    tanstackRouter({
      target: "react",
      autoCodeSplitting: true,
      routesDirectory: APP_UI_PATH + "/routes",
      generatedRouteTree: "./types/routeTree.gen.ts",
    }),
    react(),
    tailwindcss(),
  ],
  // setup proxy for the api, only used in development
  server: {
    proxy: {
      "/api": {
        target: "http://localhost:8000",
        changeOrigin: true,
        secure: false,
      },
    },
  },
  build: {
    outDir: "../dist", // relative to root!
    emptyOutDir: true,
    rollupOptions: {
      output: {
        manualChunks: (id) => {
          if (id.includes("react")) {
            return "react";
          }
        },
      },
    },
  },
  resolve: {
    alias: {
      "@": path.resolve(__dirname, APP_UI_PATH),
    },
  },
});